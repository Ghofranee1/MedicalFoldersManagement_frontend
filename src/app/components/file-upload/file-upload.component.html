<!-- file-upload.component.html -->
<div class="file-upload-container">
  <div class="header">
    <h2>Upload Files</h2>
    <button class="btn btn-secondary" (click)="cancel()">
      <i class="fas fa-arrow-left"></i> Back
    </button>
  </div>


  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-error">
    <i class="fas fa-exclamation-triangle"></i>
    {{ error }}
  </div>

  <!-- Upload Form -->
  <div class="upload-form-container">
    <form [formGroup]="uploadForm" (ngSubmit)="onSubmit()" class="upload-form">

      <!-- File Selection -->
      <div class="form-section">
        <h3>Select Files</h3>
        <div class="file-input-container">
          <input type="file" id="fileInput" multiple (change)="onFileSelected($event)" class="file-input"
            [accept]="allowedTypes.join(',')">
          <label for="fileInput" class="file-input-label">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose files or drag and drop</span>
            <small>Maximum file size: 50MB | Allowed types: PDF, Images, Word, Excel</small>
          </label>
        </div>

        <!-- Selected Files -->
        <div *ngIf="selectedFiles.length > 0" class="selected-files">
          <h4>Selected Files ({{ selectedFiles.length }})</h4>
          <div class="file-list">
            <div *ngFor="let file of selectedFiles; let i = index" class="file-item">
              <div class="file-info">
                <i [class]="getFileIcon(file)"></i>
                <div class="file-details">
                  <span class="file-name">{{ file.name }}</span>
                  <span class="file-size">{{ formatFileSize(file.size) }}</span>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-danger" (click)="removeFile(i)" title="Remove file">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- File Details -->
      <div class="form-section">
        <h3>File Details</h3>

        <!-- Department Info (Read-only display) -->
        <div class="form-group" *ngIf="isArchivist()">
          <label>Department</label>
          <div class="form-control-static">
            {{ getUserDepartmentId() }} - {{ getUserDepartmentName() }}
          </div>
        </div>

        <!-- Dossier Info (Read-only display if set from route) -->
        <div class="form-group" *ngIf="dossierId">
          <label>Dossier ID</label>
          <div class="form-control-static">
            {{ dossierId }}
          </div>
        </div>

        <!-- Dossier ID Input (only if not set from route) -->
        <div class="form-group" *ngIf="!dossierId">
          <label for="dossierIdInput">Dossier ID *</label>
          <input id="dossierIdInput" type="number" formControlName="dossierId" class="form-control"
            placeholder="Enter dossier ID"
            [class.is-invalid]="uploadForm.get('dossierId')?.invalid && uploadForm.get('dossierId')?.touched">
          <div *ngIf="uploadForm.get('dossierId')?.invalid && uploadForm.get('dossierId')?.touched"
            class="invalid-feedback">
            <div *ngIf="uploadForm.get('dossierId')?.errors?.['required']">Dossier ID is required.</div>
            <div *ngIf="uploadForm.get('dossierId')?.errors?.['pattern']">Dossier ID must be a valid number.</div>
          </div>
        </div>

        <!-- Dynamic File Type Selection -->
        <div class="form-group">
          <label for="typeFichierId">File Type</label>

          <!-- Loading indicator for file types -->
          <div *ngIf="loadingFileTypes" class="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i> Loading file types...
          </div>

          <!-- File type dropdown -->
          <select *ngIf="!loadingFileTypes" id="typeFichierId" formControlName="typeFichierId" class="form-control">
            <option value="">Select File Type (Optional)</option>
            <option *ngFor="let fileType of fileTypes" [value]="fileType.id">
              {{ fileType.nom }}
            </option>
          </select>

          <!-- Error message if file types failed to load -->
          <div *ngIf="!loadingFileTypes && fileTypes.length === 0" class="text-muted">
            <small><i class="fas fa-exclamation-triangle"></i> Unable to load file types from server. Using default
              options.</small>
          </div>
        </div>

        <div class="form-group">
          <div class="form-check">
            <input id="isInternal" type="checkbox" formControlName="isInternal" class="form-check-input">
            <label for="isInternal" class="form-check-label">
              Internal File
            </label>
          </div>
        </div>
      </div>

      <!-- Upload Progress -->
      <div *ngIf="uploading" class="upload-progress">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="uploadProgress"></div>
        </div>
        <p>Uploading files... {{ uploadProgress }}%</p>
      </div>

      <!-- Message de succès -->
      <div *ngIf="success" class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        Fichier(s) téléchargé(s) avec succès ! 
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancel()" [disabled]="uploading">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary"
          [disabled]="uploading || selectedFiles.length === 0 || !isFormValid()">
          <i class="fas fa-upload"></i>
          {{ uploading ? 'Uploading...' : 'Upload Files' }}
        </button>
      </div>
        
    </form>
  </div>
</div>