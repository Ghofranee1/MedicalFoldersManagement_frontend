<div class="admin-user-management">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Loading users...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !users.length && !loading" class="error-container">
    <div class="error-content">
      <i class="error-icon">‚ö†Ô∏è</i>
      <p class="error-message">{{ error }}</p>
      <button class="retry-btn" (click)="loadUsers()">Retry</button>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading" class="main-content">
    <!-- Header -->
    <div class="header">
      <h1 class="title">User Management</h1>
      <p class="subtitle">Manage all system users, roles, and permissions</p>
      <div *ngIf="error" class="error-banner">
        <p>{{ error }}</p>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">{{ getStats().total }}</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-value stat-doctors">{{ getStats().doctors }}</div>
        <div class="stat-label">Doctors</div>
      </div>
      <div class="stat-card">
        <div class="stat-value stat-archivists">{{ getStats().archivists }}</div>
        <div class="stat-label">Archivists</div>
      </div>
      <div class="stat-card">
        <div class="stat-value stat-admins">{{ getStats().admins }}</div>
        <div class="stat-label">Admins</div>
      </div>
      <div class="stat-card">
        <div class="stat-value stat-active">{{ getStats().active }}</div>
        <div class="stat-label">Active Users</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-card">
      <div class="controls-header">
        <div class="search-container">
          <div class="search-input-wrapper">
            <i class="search-icon">üîç</i>
            <input
              type="text"
              placeholder="Search users..."
              [(ngModel)]="searchTerm"
              (ngModelChange)="onSearchChange()"
              class="search-input"
            />
          </div>
        </div>
        <div class="controls-actions">
          <button
            class="filter-btn"
            [class.active]="showFilters"
            (click)="toggleFilters()"
          >
            <i class="filter-icon">‚öôÔ∏è</i>
            Filters
          </button>
          <button
            class="add-user-btn"
            [disabled]="actionLoading"
            (click)="navigateAndReload('/register')"
          >
            <i class="add-icon">‚ûï</i>
            <span *ngIf="actionLoading" class="spinner-small"></span>
            Cr√©er un compte d'utilisateur
          </button>
        </div>
      </div>

      <!-- Filters Section -->
      <div *ngIf="showFilters" class="filters-section">
        <div class="filters-grid">
          <div class="filter-group">
            <label class="filter-label">Role</label>
            <select
              [(ngModel)]="selectedRole"
              (ngModelChange)="onRoleFilterChange()"
              class="filter-select"
            >
              <option value="all">All Roles</option>
              <option [value]="UserRole.Doctor">Doctor</option>
              <option [value]="UserRole.Archivist">Archivist</option>
              <option [value]="UserRole.Admin">Admin</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Department</label>
            <select
              [(ngModel)]="selectedDepartment"
              (ngModelChange)="onDepartmentFilterChange()"
              class="filter-select"
            >
              <option value="all">All Departments</option>
              <option value="1">Cardiology</option>
              <option value="2">Pediatrics</option>
              <option value="3">Orthopedics</option>
              <option value="4">Emergency</option>
              <option value="5">Surgery</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="table-card">
      <div class="table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>utilisateur</th>
              <th>Role</th>
              <th>Service</th>
              <th>Derni√®re Connexion</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers; trackBy: trackByUserId" class="user-row">
              <td class="user-cell">
                <div class="user-info">
                  <div class="user-name">{{ user.firstName }} {{ user.lastName }}</div>
                  <div class="user-username">{{ '@' + user.username }}</div>
                  <div class="user-email">{{ user.email }}</div>
                </div>
              </td>
              <td class="role-cell">
                <span class="role-badge" [class]="getRoleColor(user.role)">
                  {{ getRoleName(user.role) }}
                </span>
              </td>
              <td class="department-cell">
                {{ user.departementName || 'N/A' }}
              </td>
              <td class="date-cell">
                {{ (user.lastLogin | date:'dd/MM/yyyy HH:mm') || 'N/A' }}
              </td>
              <td class="actions-cell">
                <div class="actions-container">
                  <button
                    class="action-btn edit-btn"
                    [disabled]="actionLoading"
                    (click)="openModal('edit', user)"
                    title="Edit User"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button
                    class="action-btn password-btn"
                    [disabled]="actionLoading"
                    (click)="resetPassword(user)"
                    title="Reset Password"
                  >
                    üîë
                  </button>
                  <button
                    class="action-btn delete-btn"
                    [disabled]="actionLoading"
                    (click)="openModal('delete', user)"
                    title="Delete User"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Empty State -->
        <div *ngIf="filteredUsers.length === 0 && !loading" class="empty-state">
          <p>No users found matching your criteria.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          <span *ngIf="modalType === 'create'">Create New User</span>
          <span *ngIf="modalType === 'edit'">Edit User</span>
          <span *ngIf="modalType === 'password'">Reset Password</span>
          <span *ngIf="modalType === 'delete'">Delete User</span>
        </h2>
        <button class="modal-close" (click)="closeModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <!-- Error Display -->
        <div *ngIf="modalError" class="modal-error">
          <span>{{ modalError }}</span>
        </div>

        <!-- Delete Confirmation -->
        <div *ngIf="modalType === 'delete'" class="delete-confirmation">
          <p>
            Are you sure you want to delete user <strong>{{ selectedUser?.username }}</strong>? 
            This action cannot be undone.
          </p>
          <div class="modal-actions">
            <button
              class="cancel-btn"
              [disabled]="modalLoading"
              (click)="closeModal()"
            >
              Cancel
            </button>
            <button
              class="delete-btn"
              [disabled]="modalLoading"
              (click)="deleteUser()"
            >
              <span *ngIf="modalLoading" class="spinner-small"></span>
              <span>{{ modalLoading ? 'Deleting...' : 'Delete' }}</span>
            </button>
          </div>
        </div>

        <!-- Form -->
        <div *ngIf="modalType !== 'delete'" class="modal-form">
          <!-- User Details (not for password reset) -->
          <div *ngIf="modalType !== 'password'">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">First Name *</label>
                <input
                  type="text"
                  class="form-input"
                  [class.error]="formErrors['firstName']"
                  [(ngModel)]="formData.firstName"
                  (ngModelChange)="onFormChange('firstName', $event)"
                  placeholder="Enter first name"
                />
                <div *ngIf="formErrors['firstName']" class="form-error">
                  {{ formErrors['firstName'] }}
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Last Name *</label>
                <input
                  type="text"
                  class="form-input"
                  [class.error]="formErrors['lastName']"
                  [(ngModel)]="formData.lastName"
                  (ngModelChange)="onFormChange('lastName', $event)"
                  placeholder="Enter last name"
                />
                <div *ngIf="formErrors['lastName']" class="form-error">
                  {{ formErrors['lastName'] }}
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">
                Username *
                <span *ngIf="modalType === 'create' && availabilityCheck.checking" class="spinner-small"></span>
              </label>
              <input
                type="text"
                class="form-input"
                [class.error]="formErrors['username'] || (!availabilityCheck.available && modalType === 'create')"
                [(ngModel)]="formData.username"
                (ngModelChange)="onFormChange('username', $event)"
                placeholder="Enter username"
              />
              <div *ngIf="formErrors['username']" class="form-error">
                {{ formErrors['username'] }}
              </div>
              <div *ngIf="!availabilityCheck.available && modalType === 'create'" class="form-error">
                Username already exists
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Email *</label>
              <input
                type="email"
                class="form-input"
                [class.error]="formErrors['email'] || (!availabilityCheck.available && modalType === 'create')"
                [(ngModel)]="formData.email"
                (ngModelChange)="onFormChange('email', $event)"
                placeholder="Enter email address"
              />
              <div *ngIf="formErrors['email']" class="form-error">
                {{ formErrors['email'] }}
              </div>
              <div *ngIf="!availabilityCheck.available && modalType === 'create'" class="form-error">
                Email already exists
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Role *</label>
              <select
                class="form-select"
                [(ngModel)]="formData.role"
                (ngModelChange)="onFormChange('role', $event)"
              >
                <option [value]="UserRole.Doctor">Doctor</option>
                <option [value]="UserRole.Archivist">Archivist</option>
                <option [value]="UserRole.Admin">Admin</option>
              </select>
            </div>

            <div *ngIf="formData.role === UserRole.Doctor || formData.role === UserRole.Archivist" class="form-group">
              <label class="form-label">Department *</label>
              <!--
              <select
                class="form-select"
                [class.error]="formErrors['departementId']"
                [(ngModel)]="formData.departementId"
                (ngModelChange)="onFormChange('departementId', $event)"
              >
                <option value="">Select Department</option>
                <option [value]="1">Cardiology</option>
                <option [value]="2">Pediatrics</option>
                <option [value]="3">Orthopedics</option>
                <option [value]="4">Emergency</option>
                <option [value]="5">Surgery</option>
              </select>
            -->
            <select 
                class="form-select" 
                [class.error]="formErrors['departementId']" 
                [(ngModel)]="formData.departementId" 
                (ngModelChange)="onFormChange('departementId', $event)"
                [disabled]="isLoadingDepartments">
                
                <option value="">
                    {{ isLoadingDepartments ? 'Loading departments...' : 'Select Department' }}
                </option>
                
                <option 
                    *ngFor="let department of departments" 
                    [value]="department.id">
                    {{ department.libelleFr }}
                </option>
                </select>

                <!-- Optional: Show loading spinner -->
                <div *ngIf="isLoadingDepartments" class="loading-spinner">
                Loading departments...
                </div>

                <!-- Optional: Show error message if departments fail to load -->
                <div *ngIf="!isLoadingDepartments && departments.length === 0" class="error-message">
                No departments available
                </div>
              <div *ngIf="formErrors['departementId']" class="form-error">
                {{ formErrors['departementId'] }}
              </div>
            </div>
          </div>

          <!-- Password Fields -->
          <div *ngIf="modalType === 'password' || modalType === 'create'">
            <!-- this is asking to enter the current password, but as admin you can reset without it and already it is only the admin who can access this page
            <div *ngIf="modalType === 'password'" class="form-group">
              <label class="form-label">Current Password</label>
              <input
                type="password"
                class="form-input"
                placeholder="Leave empty for admin reset"
                [(ngModel)]="formData.currentPassword"
                (ngModelChange)="onFormChange('currentPassword', $event)"
              />
              <div class="form-help">As admin, you can reset without current password</div>
            </div>
            -->
            <div class="form-group">
              <label class="form-label">
                {{ modalType === 'create' ? 'Password' : 'New Password' }} *
              </label>
              <input
                type="password"
                class="form-input"
                [class.error]="formErrors['newPassword']"
                [(ngModel)]="formData.newPassword"
                (ngModelChange)="onFormChange('newPassword', $event)"
                placeholder="Enter password"
              />
              <div *ngIf="formErrors['newPassword']" class="form-error">
                {{ formErrors['newPassword'] }}
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Confirm Password *</label>
              <input
                type="password"
                class="form-input"
                [class.error]="formErrors['confirmPassword']"
                [(ngModel)]="formData.confirmPassword"
                (ngModelChange)="onFormChange('confirmPassword', $event)"
                placeholder="Confirm password"
              />
              <div *ngIf="formErrors['confirmPassword']" class="form-error">
                {{ formErrors['confirmPassword'] }}
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button
              class="cancel-btn"
              [disabled]="modalLoading"
              (click)="closeModal()"
            >
              Cancel
            </button>
            <button
              class="save-btn"
              [disabled]="modalLoading || (modalType === 'create' && !availabilityCheck.available)"
              (click)="saveUser()"
            >
              <span *ngIf="modalLoading" class="spinner-small"></span>
              <span *ngIf="modalLoading">
                {{ modalType === 'create' ? 'Creating...' : modalType === 'edit' ? 'Updating...' : 'Resetting...' }}
              </span>
              <span *ngIf="!modalLoading">
                {{ modalType === 'create' ? 'Create User' : modalType === 'edit' ? 'Update User' : 'Reset Password' }}
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>