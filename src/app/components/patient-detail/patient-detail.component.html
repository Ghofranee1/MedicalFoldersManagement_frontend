<div class="patient-detail-overlay" (click)="onClose()">
  <div class="patient-detail-modal" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <h2>Détails du Patient</h2>
      <button class="close-btn" (click)="onClose()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Patient Information -->
    <div class="patient-info">
      <div class="patient-basic-info">
        <div class="info-row">
          <strong>IPP:</strong> {{ patient.ipp }}
        </div>
        <div class="info-row" *ngIf="patient.nomAr">
          <strong>Nom (AR):</strong> {{ patient.nomAr }} {{ patient.prenomAr }}
        </div>
         <div class="info-row">
          <strong>Date de naissance:</strong> {{ patient.dateNaissance | date:'dd/MM/yyyy' }}
        </div>
        <div class="info-row">
          <strong>Nom (FR):</strong> {{ patient.nomFr }} {{ patient.prenomFr }}
        </div>
        
       
        <div class="info-row">
          <strong>Âge:</strong> {{ getPatientAge() }} ans
        </div>
        <div class="info-row">
          <strong>Sexe:</strong> {{ patient.sexe }}
        </div>
        <div class="info-row" *ngIf="patient.phone1">
          <strong>Téléphone:</strong> {{ patient.phone1 }}
        </div>
      </div>
    </div>

    <!-- Dossier Section -->
    <div class="dossier-section">
      <h3>Dossier Médical</h3>
      
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        Chargement du dossier...
      </div>

      <!-- Error State -->
      <div *ngIf="error" class="error-state">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error }}
      </div>

      <!-- No Dossier State - archivist -->
      <div *ngIf="archivistDepartmentId && !loading && !error && !dossier" class="no-dossier-state">
        <div class="no-dossier-message">
          <i class="fas fa-folder-plus"></i>
          <p>Ce patient n'a pas de dossier dans votre département.</p>
          <button 
            class="create-dossier-btn" 
            (click)="createDossier()" 
            [disabled]="creatingDossier">
            <i class="fas fa-plus" *ngIf="!creatingDossier"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="creatingDossier"></i>
            {{ creatingDossier ? 'Création...' : 'Créer Dossier' }}
          </button>
        </div>
      </div>

      <!-- Dossier Exists and the user is an archivist-->
      <div *ngIf="archivistDepartmentId && !loading && !error && dossier" class="dossier-exists">
        <div class="dossier-card" (click)="selectDossier(dossier)">
          <div class="dossier-header">
            <h4>
              <i class="fas fa-folder-open"></i>
              Dossier Médical
            </h4>
            <span class="dossier-date">
              Créé le {{ dossier.dateCreation | date:'dd/MM/yyyy' }}
            </span>
          </div>
          
          <div class="dossier-info">
            <div class="info-item">
              <strong>Département:</strong> 
              {{ dossier.departement?.libelleFr || 'N/A' }}
            </div>
            <div class="info-item">
              <strong>Nombre de fichiers:</strong> 
              {{ dossier.nombreFichiers || 0 }}
            </div>
          </div>
          
          <div class="dossier-actions">
            <button class="view-btn">
              <i class="fas fa-eye"></i>
              Consulter
            </button>
          </div>
        </div>
      </div>

      <!-- Dossier Exists and the user is a doctor or admin-->
      <div *ngIf="!archivistDepartmentId &&!loading && !error && dossiers" class="dossiers-grid">
        <div 
          *ngFor="let dossier of dossiers" 
          class="dossier-card" 
          [class.doctor-department]="isDoctorDepartment(dossier)"
          (click)="selectDossier(dossier)">
          
          <div class="dossier-header">
            <h4>
              {{ dossier.departement?.libelleFr }}
              <i class="fas fa-star department-indicator" 
                 *ngIf="isDoctorDepartment(dossier)"
                 title="Votre département"></i>
            </h4>
            <span class="dossier-id">ID: {{ dossier.id }}</span>
          </div>
          
          <div class="dossier-info">
            <div class="info-row">
              <span class="label">Date de création:</span>
              <span class="value">{{ dossier.dateCreation | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="info-row">
              <span class="label">Nombre de fichiers:</span>
              <span class="value">{{ dossier.nombreFichiers || 0 }}</span>
            </div>
          </div>
          
          <!-- Priority badge for doctor's department -->
          <div class="department-badge" *ngIf="isDoctorDepartment(dossier)">
            <span>Votre département</span>
          </div>
        </div>
      </div>

      <!-- No dossiers found -->
      <div *ngIf="!archivistDepartmentId && !loading && !error && dossiers.length === 0" class="no-dossiers">
        <i class="fas fa-folder-open"></i>
        <p>Aucun dossier médical trouvé pour ce patient</p>
      </div>
    </div>

    <!-- Dossier Detail Modal -->
    <!-- 
    <div *ngIf="selectedDossier" class="patient-detail-overlay" (click)="clearSelection()">
      <div class="patient-detail-panel" (click)="$event.stopPropagation()">
        <app-dossier-detail [fullDossier]="selectedDossier"
                            [loading]="dossierDetailLoading"
                            [error]="dossierDetailError"
          (close)="closeDossierDetail()">
        </app-dossier-detail>
      </div>
    </div>
  -->
      <app-dossier-detail 
      *ngIf="selectedDossier" 
      [fullDossier]="selectedDossier"
      [loading]="dossierDetailLoading"
      [error]="dossierDetailError"
      (close)="closeDossierDetail()">
    </app-dossier-detail>
    
  </div>
</div>